# R study^2025.7.25^
## R日期时间~study~
### R 日期和日期时间类型
R 日期可以保存为 Date 类型，一般用整数保存，数值为从 1970-1-1经过的天数

 - **POSIXct** 把日期时间保存为从 1970 年 1 月 1 日零时到该日期时间的时间间隔秒数，所以数据框中需要保存日期时用POSIXct 比较合适，需要显示时再转换成字符串形式
 -  **POSIXlt**把日期时间保存为一个包含年、月、日、星期、时、分、秒等成分的列表，所以求这些成分可以从 POSIXlt 格式日期的列表变量中获得
 - 日期时间会涉及到所在时区、夏时制等问题

基础的 R 用 `as.Date()、as.POSIXct()` 等函数生成日期型和日期时间型，R 扩展包 lubridate 提供了多个方便函数，可以更容易地生成、转换、管理日期型和日期时间型数据
```r
library(lubridate)
lubridate::today()
[1] "2025-07-26"
lubridate::now()
[1] "2025-07-26 00:18:15 CST"
```

> 结果显示中出现的 CST 是**时区**，这里使用了操作系统提供的当前时区。CST **不是**一个含义清晰的**时区**，在不同国家对应不同的时区，在中国代表中国标准时间（北京时间）

用 `lubridate::ymd(), lubridate::mdy(), lubridate::dmy()` 将字符型向量转换为日期型向量(year,month,day)
```r
ymd(c("1998-3-10", "2018-01-17", "18-1-17"))
## [1] "1998-03-10" "2018-01-17" "2018-01-17"
mdy(c("3-10-1998", "01-17-2018"))
## [1] "1998-03-10" "2018-01-17"
dmy(c("10-3-1998", "17-01-2018"))
## [1] "1998-03-10" "2018-01-17"
```
lubridate 包的 ymd、mdy、dmy 等函数添加 hms、hm、h 等后缀，可以用于将**字符串**转换成**日期时间**
```r
ymd_hms("1998-03-16 13:15:45")
## [1] "1998-03-16 13:15:45 UTC"
```
---
### 时区和时区转换
UTC 是时区，UTC 是协调世界时 (Universal Time Coordinated) 英文缩写，是由国际无线电咨询委员会规定和推荐, 并由国际时间局 (BIH) 负责保持的以秒为基础的时间标度
UTC 相当于本初子午线(即经度 0 度) 上的平均太阳时，过去曾用格林威治平均时 (GMT) 来表示。北京时间比 UTC 时间早(快)8 小时
当天UTC零点=当天北京8：00

在 `Date()、as.DateTime()、ymd()` 等函数中，可以用 **tz= 指定时区**，比如北京时间可指定为 `tz="Etc/GMT-8"`或 `tz="Asia/Shanghai"`
为了将某个时间转换到指定的时区，而不改变真正的时间，用 `with_tz()` 函数
为了保持表面的时间（时钟显示的日期时间）不变，但将真正的时间修改到另外的时区，用 `force_tz()` 或`force_tzs()`，其中 `force_tzs()` 可以将每个时间单独应用不同的时区
```r
with_tz(ymd_hms(c("1998-03-16 13:15:45",
"2023-03-14 10:11:12"),
tz="Asia/Shanghai"), tzone="UTC")
## [1] "1998-03-16 05:15:45 UTC" "2023-03-14 02:11:12 UTC"
force_tz(ymd_hms(c("1998-03-16 13:15:45",
"2023-03-14 10:11:12"),
tz="Asia/Shanghai"), tzone="UTC")
## [1] "1998-03-16 13:15:45 UTC" "2023-03-14 10:11:12 UTC"
force_tzs(ymd_hms(c("1998-03-16 13:15:45",
"2023-03-14 10:11:12"),
tz="Asia/Shanghai"),
tzones=c("Etc/GMT-6", "Etc/GMT-10"))
## [1] "1998-03-16 07:15:45 UTC" "2023-03-14 00:11:12 UTC"
```
这将北京时间"1998-03-16 13:15:45" 改成了东 6 区时间，对应到 UTC 就是钟面时间减 6，所以 13 点变成 7点，将北京时间"2023-03-14 10:11:12" 改成了东 10 区时间，对应到 UTC 就是钟面时间减 10，所以 10 点变成 0 点

---
### 从数值生成日期数据
`lubridate::make_date(year, month, day)` 可以从三个数值构成日期向量
```r
make_date(1998,3,10)
## [1] "1998-03-10"
make_datetime(1998,3,16,13,15,45.2)
## [1] "1998-03-16 13:15:45 UTC"
```
`lubridate::make_datetime(year, month, day, hour, min, sec)` 可以从最多六个数值组成日期时间，其中时分秒缺省值都是 0

 - `make_datetime`是年月日+时间
 - `make_date`是年月日（单纯日期）

在 make_date() 和 make_datetime() 都可以用 tz 选项指定时区，但仅支持单个时区

---
### 日期和日期时间之间的转换
```r
as_date(as.POSIXct("1998-03-16 13:15:45"))
## [1] "1998-03-16"
as.Date("1998-03-16") |>
as_datetime() |>
class()
## [1] "POSIXct" "POSIXt"
```
### 日期显示格式
从某个版本的 R 起，`as.character()` 函数在处理 `POSIXt` 类型（日期时间对象）时，**不再支持 `format=` 参数**。你应该使用 `format()` 函数来格式化日期
```r
x <- as.POSIXct(c('1998-03-16', '2015-11-22'))
as.character(x)
## [1] "1998-03-16" "2015-11-22"
as.character(x, format='%m/%d/%Y')
## [1] "03/16/1998" "11/22/2015"
format(x, format='%m/%d/%Y')
[1] "02/22/1999" "12/12/1988"
```
格式中 `“%Y”` 代表四位的公元年号，`“%m”` 代表两位的月份数字，`“%d”` 代表两位的月内日期号
这些格式缩写也被用在从字符串转换在日期
比如 `readr::read_csv` 在指定某一列为 `col_date()` 时，可以指定格式如 `format="%m/%d/%Y"`
```r
as.Date(c("12/6/2022", "1/1/2023"), format="%m/%d/%Y")
[1] "2022-12-06" "2023-01-01"
```
(支持format参数）
"15Mar98" 这样的日期在英文环境中比较常见，但是在 R 中的处理比较复杂。
在下面的例子中，R 日期被转换成了类似"Mar98" 这样的格式，在 format 选项中用了 “%b” 代表三英文字母月份缩写，但是因为月份缩写依赖于**操作系统默认语言环境**，需要用 **Sys.setlocale()** 函数设置语言环境为"C"
```r
format(x, format='%b/%Y')
[1] "2月/1999"  "12月/1988"
old.lctime <- Sys.getlocale('LC_TIME')
Sys.setlocale('LC_TIME', 'C')
[1] "C"
format(x, format='%b/%Y')
[1] "Feb/1999" "Dec/1988"
format(x, format='%b/%y')
[1] "Feb/99" "Dec/88"
```
“%y” 表示两位数的年份
> is.POSIXct(x)
> [1] TRUE 
> is.character(x)
> [1] FALSE 
> is.character(format(x, format='%m/%d/%Y'))
> [1] TRUE
> is.POSIXct(format(x, format='%m/%d/%Y'))
> [1] FALSE

```r
x <- as.POSIXct('1998-03-16 13:15:45')
as.character(x)
## [1] "1998-03-16 13:15:45"
format(x,format='%H:%M:%S')
## [1] "13:15:45"
```
这里 **“%H”** 代表**小时**（按 24 小时制），**“%M”** 代表两位的**分钟数字**，**“%S”** 代表两位的**秒数**

---
### 访问日期时间的组成值

 - year() 取出年
 - month() 取出月份数值
 - mday() 取出日数值
 - yday() 取出日期在一年中的序号，元旦为 1
 - wday() 取出日期在一个星期内的序号，但是一个星期从星期天开始，星期天为 1, 星期一为 2，星期六为 7
 - hour() 取出小时 
 - minute() 取出分钟
 - second() 取出秒
`lubridate` 的这些成分函数还允许被赋值，结果就修改了相应元素的值
```r
x <- as.POSIXct("2018-1-17 13:15:40")
year(x) <- 2000
month(x) <- 1
mday(x) <- 1
x
## [1] "2000-01-01 13:15:40 CST"
```

<!--stackedit_data:
eyJoaXN0b3J5IjpbMjAzNDk4OTIzXX0=
-->